<!DOCTYPE html>
<html lang="en">
{% include "head.html" %}
<body>
{% include "navbar.html" %}
<div id="main" class="container">
    <h1>{{ event.title()|e }}</h1>
    <h2>{{ event.module()|e }}</h2>
    <p>Starts at <b>{{ event.start()|e }}</b> and finishes at <b>{{ event.end()|e }}</b></p>
    <p><a class="card-link" href="https://intra.epitech.eu{{ event.intra_page()|e }}">See event on intra</a></p>

    <p>
        <button id="save" class="btn btn-outline-primary">Save</button>
        <button id="set-all-present" class="btn btn-outline-success">Set all as Present</button>
        <button id="set-all-missing" class="btn btn-outline-danger">Set all as Missing</button>
        <button id="set-all-not-applicable" class="btn btn-outline-warning">Set all as N/A</button>
        <button id="set-all-none" class="btn btn-outline-secondary">Set all as None</button>
    </p>

    <div id="callback-save"></div>

    <form>
        <table class="table table-sm">
            <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Login</th>
                <th scope="col">Status</th>
            </tr>
            </thead>
            <tbody>
            {% for student in event.students %}
            <tr>
                <td>{{ student.get_name()|e }}</td>
                <td>{{ student.get_login()|e }}</td>
                <td>
                    <div class="btn-group btn-group-sm btn-group-toggle" data-toggle="buttons">
                        {% include "cards/student-presence.html" %}
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </form>
</div>
{% include "footer.html" %}
<script>
    $("#save").click(function () {
        let URL = window.location.href + "/save";
        fetch(URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify($('form').serializeArray()),
        })
            .then(function (response) {
                if (!response.ok) {
                    response.json().then(data => {
                        $("#callback-save").html('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Could not save changes</strong> ' + data + '.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                    });
                    throw Error("this is normal, by throwing this error the error alert will show up.");
                }
                return response;
            }).then(function (response) {
            $("#callback-save").html('<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Changes saved</strong> You can do something else now.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
        }).catch(function (error) {
            $("#callback-save").html('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Could not save changes</strong> ' + error + '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
        });
    });

    function setAll(presence) {
        for (let field of document.getElementsByTagName("form")[0].elements) {
            if (field.value === presence) {
                field.checked = true;
                field.parentElement.classList.add("active");
            } else {
                field.checked = false;
                field.parentElement.classList.remove("active");
            }
        }
    }

    $("#set-all-present").click(function () {
        setAll("Present");
    });

    $("#set-all-missing").click(function () {
        setAll("Missing");
    });

    $("#set-all-not-applicable").click(function () {
        setAll("NotApplicable");
    });

    $("#set-all-none").click(function () {
        setAll("None");
    });
</script>
</body>
</html>